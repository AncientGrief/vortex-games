"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerActions = void 0;
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const PriorityTypeButton_1 = __importDefault(require("./views/PriorityTypeButton"));
const mergeBackup_1 = require("./mergeBackup");
function resetPriorities(props) {
    const { context, refreshFunc } = props;
    const state = context.api.getState();
    const profile = vortex_api_1.selectors.activeProfile(state);
    const loadOrder = vortex_api_1.util.getSafe(state, ['persistent', 'loadOrder', profile.id], {});
    const newLO = Object.keys(loadOrder).reduce((accum, key) => {
        const loEntry = loadOrder[key];
        accum[key] = Object.assign(Object.assign({}, loEntry), { prefix: loEntry.pos + 1 });
        return accum;
    }, {});
    context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
    if (refreshFunc !== undefined) {
        refreshFunc();
    }
    return newLO;
}
exports.registerActions = (props) => {
    const { context, refreshFunc, getModLimitPatcher } = props;
    const openTW3DocPath = () => {
        const docPath = path_1.default.join(vortex_api_1.util.getVortexPath('documents'), 'The Witcher 3');
        vortex_api_1.util.opn(docPath).catch(() => null);
    };
    const isTW3 = (gameId = undefined) => {
        if (gameId !== undefined) {
            return (gameId === common_1.GAME_ID);
        }
        const state = context.api.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return (gameMode === common_1.GAME_ID);
    };
    context.registerAction('mods-action-icons', 300, 'start-install', {}, 'Import Script Merges', instanceIds => { mergeBackup_1.makeOnContextImport(context, instanceIds[0]); }, instanceIds => {
        var _a;
        const state = context.api.getState();
        const mods = vortex_api_1.util.getSafe(state, ['persistent', 'mods', common_1.GAME_ID], {});
        if (((_a = mods[instanceIds === null || instanceIds === void 0 ? void 0 : instanceIds[0]]) === null || _a === void 0 ? void 0 : _a.type) !== 'collection') {
            return false;
        }
        const activeGameId = vortex_api_1.selectors.activeGameId(state);
        return activeGameId === common_1.GAME_ID;
    });
    context.registerAction('mod-icons', 500, 'savegame', {}, 'Apply Mod Limit Patch', () => {
        getModLimitPatcher().ensureModLimitPatch();
    }, () => true);
    context.registerAction('generic-load-order-icons', 300, PriorityTypeButton_1.default, {}, undefined, isTW3);
    context.registerAction('mod-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('generic-load-order-icons', 300, 'open-ext', {}, 'Open TW3 Documents Folder', openTW3DocPath, isTW3);
    context.registerAction('generic-load-order-icons', 100, 'loot-sort', {}, 'Reset Priorities', () => {
        context.api.showDialog('info', 'Reset Priorities', {
            bbcode: context.api.translate('This action will revert all manually set priorities and will re-instate priorities in an incremental '
                + 'manner starting from 1. Are you sure you want to do this ?', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Reset Priorities', action: () => resetPriorities(props) },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
    context.registerAction('generic-load-order-icons', 100, 'loot-sort', {}, 'Sort by Deploy Order', () => {
        context.api.showDialog('info', 'Sort by Deployment Order', {
            bbcode: context.api.translate('This action will set priorities using the deployment rules '
                + 'defined in the mods page. Are you sure you wish to proceed ?[br][/br][br][/br]'
                + 'Please be aware that any externally added mods (added manually or by other tools) will be pushed '
                + 'to the bottom of the list, while all mods that have been installed through Vortex will shift '
                + 'in position to match the deploy order!', { ns: common_1.I18N_NAMESPACE }),
        }, [
            { label: 'Cancel', action: () => {
                    return;
                } },
            { label: 'Sort by Deploy Order', action: () => {
                    const state = context.api.getState();
                    const gameMods = state.persistent.mods[common_1.GAME_ID] || {};
                    const profile = vortex_api_1.selectors.activeProfile(state);
                    const mods = Object.keys(gameMods)
                        .filter(key => vortex_api_1.util.getSafe(profile, ['modState', key, 'enabled'], false))
                        .map(key => gameMods[key]);
                    return vortex_api_1.util.sortMods(common_1.GAME_ID, mods, context.api)
                        .then(sorted => {
                        const loadOrder = vortex_api_1.util.getSafe(state, ['persistent', 'loadOrder', profile.id], {});
                        const filtered = Object.keys(loadOrder).filter(key => sorted.find(mod => mod.id === key) !== undefined);
                        const manuallyAdded = Object.keys(loadOrder).filter(key => !filtered.includes(key));
                        const minimumIdx = manuallyAdded
                            .filter(key => key.includes(common_1.LOCKED_PREFIX))
                            .reduce((min, key) => {
                            if (min <= loadOrder[key].pos) {
                                min = loadOrder[key].pos + 1;
                            }
                            return min;
                        }, 0);
                        const manualLO = manuallyAdded.reduce((accum, key, idx) => {
                            if (key.includes(common_1.LOCKED_PREFIX)) {
                                accum[key] = loadOrder[key];
                                return accum;
                            }
                            const minimumPosition = (filtered.length + minimumIdx + 1);
                            if (loadOrder[key].pos < minimumPosition) {
                                accum[key] = Object.assign(Object.assign({}, loadOrder[key]), { pos: loadOrder[key].pos + (minimumPosition + idx), prefix: loadOrder[key].pos + (minimumPosition + idx + 1) });
                                return accum;
                            }
                            else {
                                accum[key] = loadOrder[key];
                                return accum;
                            }
                        }, {});
                        const newLO = filtered.reduce((accum, key) => {
                            const loEntry = loadOrder[key];
                            const idx = sorted.findIndex(mod => mod.id === key);
                            const assignedIdx = minimumIdx + idx;
                            accum[key] = Object.assign(Object.assign({}, loEntry), { pos: assignedIdx, prefix: assignedIdx + 1 });
                            return accum;
                        }, manualLO);
                        context.api.store.dispatch(vortex_api_1.actions.setLoadOrder(profile.id, newLO));
                        if (refreshFunc !== undefined) {
                            refreshFunc();
                        }
                    })
                        .catch(err => {
                        const allowReport = !(err instanceof vortex_api_1.util.CycleError);
                        context.api.showErrorNotification('Failed to sort by deployment order', err, { allowReport });
                    });
                } },
        ]);
    }, () => {
        const state = context.api.store.getState();
        const gameMode = vortex_api_1.selectors.activeGameId(state);
        return gameMode === common_1.GAME_ID;
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbmJhckFjdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpY29uYmFyQWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBd0I7QUFDeEIsMkNBQWlFO0FBR2pFLHFDQUF5RjtBQUd6RixvRkFBNEQ7QUFJNUQsK0NBQW9EO0FBVXBELFNBQVMsZUFBZSxDQUFDLEtBQWE7SUFDcEMsTUFBTSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDdkMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNyQyxNQUFNLE9BQU8sR0FBRyxzQkFBUyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQyxNQUFNLFNBQVMsR0FBRyxpQkFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUN6RCxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxtQ0FDTCxPQUFPLEtBQ1YsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUN4QixDQUFDO1FBQ0YsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsb0JBQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxLQUFZLENBQUMsQ0FBQyxDQUFDO0lBQzNFLElBQUksV0FBVyxLQUFLLFNBQVMs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QUFDLENBQUM7eUJBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO3dCQUNYLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQyxHQUFHLFlBQVksaUJBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQzt3QkFDdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQ3pFLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztvQkFDckIsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxFQUFDO1NBQ0gsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxFQUFFLEdBQUcsRUFBRTtRQUNOLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzNDLE1BQU0sUUFBUSxHQUFHLHNCQUFTLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9DLE9BQU8sUUFBUSxLQUFLLGdCQUFPLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgYWN0aW9ucywgZnMsIHNlbGVjdG9ycywgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcclxuXHJcbmltcG9ydCB7IHNldFByaW9yaXR5VHlwZSB9IGZyb20gJy4vYWN0aW9ucyc7XHJcbmltcG9ydCB7IEdBTUVfSUQsIGdldFByaW9yaXR5VHlwZUJyYW5jaCwgSTE4Tl9OQU1FU1BBQ0UsIExPQ0tFRF9QUkVGSVggfSBmcm9tICcuL2NvbW1vbic7XHJcbmltcG9ydCB7IFByaW9yaXR5TWFuYWdlciwgUHJpb3JpdHlUeXBlIH0gZnJvbSAnLi9wcmlvcml0eU1hbmFnZXInO1xyXG5cclxuaW1wb3J0IFByaW9yaXR5VHlwZUJ1dHRvbiBmcm9tICcuL3ZpZXdzL1ByaW9yaXR5VHlwZUJ1dHRvbic7XHJcblxyXG5pbXBvcnQgeyBleHBvcnRNZW51TW9kLCBpbXBvcnRNZW51TW9kIH0gZnJvbSAnLi9tZW51bW9kJztcclxuXHJcbmltcG9ydCB7IG1ha2VPbkNvbnRleHRJbXBvcnQgfSBmcm9tICcuL21lcmdlQmFja3VwJztcclxuaW1wb3J0IHsgTW9kTGltaXRQYXRjaGVyIH0gZnJvbSAnLi9tb2RMaW1pdFBhdGNoJztcclxuXHJcbmludGVyZmFjZSBJUHJvcHMge1xyXG4gIGNvbnRleHQ6IHR5cGVzLklFeHRlbnNpb25Db250ZXh0O1xyXG4gIHJlZnJlc2hGdW5jOiAoKSA9PiB2b2lkO1xyXG4gIGdldFByaW9yaXR5TWFuYWdlcjogKCkgPT4gUHJpb3JpdHlNYW5hZ2VyO1xyXG4gIGdldE1vZExpbWl0UGF0Y2hlcjogKCkgPT4gTW9kTGltaXRQYXRjaGVyO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZXNldFByaW9yaXRpZXMocHJvcHM6IElQcm9wcykge1xyXG4gIGNvbnN0IHsgY29udGV4dCwgcmVmcmVzaEZ1bmMgfSA9IHByb3BzO1xyXG4gIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuZ2V0U3RhdGUoKTtcclxuICBjb25zdCBwcm9maWxlID0gc2VsZWN0b3JzLmFjdGl2ZVByb2ZpbGUoc3RhdGUpO1xyXG4gIGNvbnN0IGxvYWRPcmRlciA9IHV0aWwuZ2V0U2FmZShzdGF0ZSwgWydwZXJzaXN0ZW50JywgJ2xvYWRPcmRlcicsIHByb2ZpbGUuaWRdLCB7fSk7XHJcbiAgY29uc3QgbmV3TE8gPSBPYmplY3Qua2V5cyhsb2FkT3JkZXIpLnJlZHVjZSgoYWNjdW0sIGtleSkgPT4ge1xyXG4gICAgY29uc3QgbG9FbnRyeSA9IGxvYWRPcmRlcltrZXldO1xyXG4gICAgYWNjdW1ba2V5XSA9IHtcclxuICAgICAgLi4ubG9FbnRyeSxcclxuICAgICAgcHJlZml4OiBsb0VudHJ5LnBvcyArIDEsXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGFjY3VtO1xyXG4gIH0sIHt9KTtcclxuICBjb250ZXh0LmFwaS5zdG9yZS5kaXNwYXRjaChhY3Rpb25zLnNldExvYWRPcmRlcihwcm9maWxlLmlkLCBuZXdMTyBhcyBhbnkpKTtcclxuICBpZiAocmVmcmVzaEZ1bmMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgcmVmcmVzaEZ1bmMoKTtcclxuICB9XHJcbiAgcmV0dXJuIG5ld0xPO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgcmVnaXN0ZXJBY3Rpb25zID0gKHByb3BzOiBJUHJvcHMpID0+IHtcclxuICBjb25zdCB7IGNvbnRleHQsIHJlZnJlc2hGdW5jLCBnZXRNb2RMaW1pdFBhdGNoZXIgfSA9IHByb3BzO1xyXG4gIGNvbnN0IG9wZW5UVzNEb2NQYXRoID0gKCkgPT4ge1xyXG4gICAgY29uc3QgZG9jUGF0aCA9IHBhdGguam9pbih1dGlsLmdldFZvcnRleFBhdGgoJ2RvY3VtZW50cycpLCAnVGhlIFdpdGNoZXIgMycpO1xyXG4gICAgdXRpbC5vcG4oZG9jUGF0aCkuY2F0Y2goKCkgPT4gbnVsbCk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgaXNUVzMgPSAoZ2FtZUlkID0gdW5kZWZpbmVkKSA9PiB7XHJcbiAgICBpZiAoZ2FtZUlkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuIChnYW1lSWQgPT09IEdBTUVfSUQpO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LmFwaS5nZXRTdGF0ZSgpO1xyXG4gICAgY29uc3QgZ2FtZU1vZGUgPSBzZWxlY3RvcnMuYWN0aXZlR2FtZUlkKHN0YXRlKTtcclxuICAgIHJldHVybiAoZ2FtZU1vZGUgPT09IEdBTUVfSUQpO1xyXG4gIH07XHJcblxyXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ21vZHMtYWN0aW9uLWljb25zJywgMzAwLCAnc3RhcnQtaW5zdGFsbCcsIHt9LCAnSW1wb3J0IFNjcmlwdCBNZXJnZXMnLFxyXG4gICAgaW5zdGFuY2VJZHMgPT4geyBtYWtlT25Db250ZXh0SW1wb3J0KGNvbnRleHQsIGluc3RhbmNlSWRzWzBdKTsgfSxcclxuICAgIGluc3RhbmNlSWRzID0+IHtcclxuICAgICAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LmFwaS5nZXRTdGF0ZSgpO1xyXG4gICAgICBjb25zdCBtb2RzID0gdXRpbC5nZXRTYWZlKHN0YXRlLCBbJ3BlcnNpc3RlbnQnLCAnbW9kcycsIEdBTUVfSURdLCB7fSk7XHJcbiAgICAgIGlmIChtb2RzW2luc3RhbmNlSWRzPy5bMF1dPy50eXBlICE9PSAnY29sbGVjdGlvbicpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgYWN0aXZlR2FtZUlkID0gc2VsZWN0b3JzLmFjdGl2ZUdhbWVJZChzdGF0ZSk7XHJcbiAgICAgIHJldHVybiBhY3RpdmVHYW1lSWQgPT09IEdBTUVfSUQ7XHJcbiAgICB9KTtcclxuXHJcbiAgY29udGV4dC5yZWdpc3RlckFjdGlvbignbW9kLWljb25zJywgNTAwLCAnc2F2ZWdhbWUnLCB7fSwgJ0FwcGx5IE1vZCBMaW1pdCBQYXRjaCcsICgpID0+IHtcclxuICAgIGdldE1vZExpbWl0UGF0Y2hlcigpLmVuc3VyZU1vZExpbWl0UGF0Y2goKTtcclxuICB9LCAoKSA9PiB0cnVlKTtcclxuXHJcbiAgY29udGV4dC5yZWdpc3RlckFjdGlvbignZ2VuZXJpYy1sb2FkLW9yZGVyLWljb25zJywgMzAwLCBQcmlvcml0eVR5cGVCdXR0b24sIHt9LFxyXG4gICAgdW5kZWZpbmVkLCBpc1RXMyk7XHJcblxyXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ21vZC1pY29ucycsIDMwMCwgJ29wZW4tZXh0Jywge30sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAnT3BlbiBUVzMgRG9jdW1lbnRzIEZvbGRlcicsIG9wZW5UVzNEb2NQYXRoLCBpc1RXMyk7XHJcblxyXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ2dlbmVyaWMtbG9hZC1vcmRlci1pY29ucycsIDMwMCwgJ29wZW4tZXh0Jywge30sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAnT3BlbiBUVzMgRG9jdW1lbnRzIEZvbGRlcicsIG9wZW5UVzNEb2NQYXRoLCBpc1RXMyk7XHJcblxyXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ2dlbmVyaWMtbG9hZC1vcmRlci1pY29ucycsIDEwMCwgJ2xvb3Qtc29ydCcsIHt9LCAnUmVzZXQgUHJpb3JpdGllcycsXHJcbiAgICAoKSA9PiB7XHJcbiAgICAgIGNvbnRleHQuYXBpLnNob3dEaWFsb2coJ2luZm8nLCAnUmVzZXQgUHJpb3JpdGllcycsIHtcclxuICAgICAgICBiYmNvZGU6IGNvbnRleHQuYXBpLnRyYW5zbGF0ZSgnVGhpcyBhY3Rpb24gd2lsbCByZXZlcnQgYWxsIG1hbnVhbGx5IHNldCBwcmlvcml0aWVzIGFuZCB3aWxsIHJlLWluc3RhdGUgcHJpb3JpdGllcyBpbiBhbiBpbmNyZW1lbnRhbCAnXHJcbiAgICAgICAgICArICdtYW5uZXIgc3RhcnRpbmcgZnJvbSAxLiBBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZG8gdGhpcyA/JywgeyBuczogSTE4Tl9OQU1FU1BBQ0UgfSksXHJcbiAgICAgIH0sIFtcclxuICAgICAgICB7IGxhYmVsOiAnQ2FuY2VsJywgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfX0sXHJcbiAgICAgICAgeyBsYWJlbDogJ1Jlc2V0IFByaW9yaXRpZXMnLCBhY3Rpb246ICgpID0+IHJlc2V0UHJpb3JpdGllcyhwcm9wcykgfSxcclxuICAgICAgXSk7XHJcbiAgICB9LCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuc3RvcmUuZ2V0U3RhdGUoKTtcclxuICAgICAgY29uc3QgZ2FtZU1vZGUgPSBzZWxlY3RvcnMuYWN0aXZlR2FtZUlkKHN0YXRlKTtcclxuICAgICAgcmV0dXJuIGdhbWVNb2RlID09PSBHQU1FX0lEO1xyXG4gICAgfSk7XHJcblxyXG4gIGNvbnRleHQucmVnaXN0ZXJBY3Rpb24oJ2dlbmVyaWMtbG9hZC1vcmRlci1pY29ucycsIDEwMCwgJ2xvb3Qtc29ydCcsIHt9LCAnU29ydCBieSBEZXBsb3kgT3JkZXInLFxyXG4gICAgKCkgPT4ge1xyXG4gICAgICBjb250ZXh0LmFwaS5zaG93RGlhbG9nKCdpbmZvJywgJ1NvcnQgYnkgRGVwbG95bWVudCBPcmRlcicsIHtcclxuICAgICAgICBiYmNvZGU6IGNvbnRleHQuYXBpLnRyYW5zbGF0ZSgnVGhpcyBhY3Rpb24gd2lsbCBzZXQgcHJpb3JpdGllcyB1c2luZyB0aGUgZGVwbG95bWVudCBydWxlcyAnXHJcbiAgICAgICAgICArICdkZWZpbmVkIGluIHRoZSBtb2RzIHBhZ2UuIEFyZSB5b3Ugc3VyZSB5b3Ugd2lzaCB0byBwcm9jZWVkID9bYnJdWy9icl1bYnJdWy9icl0nXHJcbiAgICAgICAgICArICdQbGVhc2UgYmUgYXdhcmUgdGhhdCBhbnkgZXh0ZXJuYWxseSBhZGRlZCBtb2RzIChhZGRlZCBtYW51YWxseSBvciBieSBvdGhlciB0b29scykgd2lsbCBiZSBwdXNoZWQgJ1xyXG4gICAgICAgICAgKyAndG8gdGhlIGJvdHRvbSBvZiB0aGUgbGlzdCwgd2hpbGUgYWxsIG1vZHMgdGhhdCBoYXZlIGJlZW4gaW5zdGFsbGVkIHRocm91Z2ggVm9ydGV4IHdpbGwgc2hpZnQgJ1xyXG4gICAgICAgICAgKyAnaW4gcG9zaXRpb24gdG8gbWF0Y2ggdGhlIGRlcGxveSBvcmRlciEnLCB7IG5zOiBJMThOX05BTUVTUEFDRSB9KSxcclxuICAgICAgfSwgW1xyXG4gICAgICAgIHsgbGFiZWw6ICdDYW5jZWwnLCBhY3Rpb246ICgpID0+IHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9fSxcclxuICAgICAgICB7IGxhYmVsOiAnU29ydCBieSBEZXBsb3kgT3JkZXInLCBhY3Rpb246ICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuZ2V0U3RhdGUoKTtcclxuICAgICAgICAgIGNvbnN0IGdhbWVNb2RzID0gc3RhdGUucGVyc2lzdGVudC5tb2RzW0dBTUVfSURdIHx8IHt9O1xyXG4gICAgICAgICAgY29uc3QgcHJvZmlsZSA9IHNlbGVjdG9ycy5hY3RpdmVQcm9maWxlKHN0YXRlKTtcclxuICAgICAgICAgIGNvbnN0IG1vZHMgPSBPYmplY3Qua2V5cyhnYW1lTW9kcylcclxuICAgICAgICAgICAgLmZpbHRlcihrZXkgPT4gdXRpbC5nZXRTYWZlKHByb2ZpbGUsIFsnbW9kU3RhdGUnLCBrZXksICdlbmFibGVkJ10sIGZhbHNlKSlcclxuICAgICAgICAgICAgLm1hcChrZXkgPT4gZ2FtZU1vZHNba2V5XSk7XHJcbiAgICAgICAgICByZXR1cm4gdXRpbC5zb3J0TW9kcyhHQU1FX0lELCBtb2RzLCBjb250ZXh0LmFwaSlcclxuICAgICAgICAgICAgLnRoZW4oc29ydGVkID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBsb2FkT3JkZXIgPSB1dGlsLmdldFNhZmUoc3RhdGUsIFsncGVyc2lzdGVudCcsICdsb2FkT3JkZXInLCBwcm9maWxlLmlkXSwge30pO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gT2JqZWN0LmtleXMobG9hZE9yZGVyKS5maWx0ZXIoa2V5ID0+XHJcbiAgICAgICAgICAgICAgICBzb3J0ZWQuZmluZChtb2QgPT4gbW9kLmlkID09PSBrZXkpICE9PSB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG1hbnVhbGx5QWRkZWQgPSBPYmplY3Qua2V5cyhsb2FkT3JkZXIpLmZpbHRlcihrZXkgPT4gIWZpbHRlcmVkLmluY2x1ZGVzKGtleSkpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG1pbmltdW1JZHggPSBtYW51YWxseUFkZGVkXHJcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGtleSA9PiBrZXkuaW5jbHVkZXMoTE9DS0VEX1BSRUZJWCkpXHJcbiAgICAgICAgICAgICAgICAucmVkdWNlKChtaW4sIGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBpZiAobWluIDw9IGxvYWRPcmRlcltrZXldLnBvcykge1xyXG4gICAgICAgICAgICAgICAgICAgIG1pbiA9IGxvYWRPcmRlcltrZXldLnBvcyArIDE7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIG1pbjtcclxuICAgICAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG1hbnVhbExPID0gbWFudWFsbHlBZGRlZC5yZWR1Y2UoKGFjY3VtLCBrZXksIGlkeCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGtleS5pbmNsdWRlcyhMT0NLRURfUFJFRklYKSkge1xyXG4gICAgICAgICAgICAgICAgICBhY2N1bVtrZXldID0gbG9hZE9yZGVyW2tleV07XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiBhY2N1bTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBtaW5pbXVtUG9zaXRpb24gPSAoZmlsdGVyZWQubGVuZ3RoICsgbWluaW11bUlkeCArIDEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcmRlcltrZXldLnBvcyA8IG1pbmltdW1Qb3NpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICBhY2N1bVtrZXldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLmxvYWRPcmRlcltrZXldLFxyXG4gICAgICAgICAgICAgICAgICAgIHBvczogbG9hZE9yZGVyW2tleV0ucG9zICsgKG1pbmltdW1Qb3NpdGlvbiArIGlkeCksXHJcbiAgICAgICAgICAgICAgICAgICAgcHJlZml4OiBsb2FkT3JkZXJba2V5XS5wb3MgKyAobWluaW11bVBvc2l0aW9uICsgaWR4ICsgMSksXHJcbiAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiBhY2N1bTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGFjY3VtW2tleV0gPSBsb2FkT3JkZXJba2V5XTtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0sIHt9KTtcclxuICAgICAgICAgICAgICBjb25zdCBuZXdMTyA9IGZpbHRlcmVkLnJlZHVjZSgoYWNjdW0sIGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbG9FbnRyeSA9IGxvYWRPcmRlcltrZXldO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gc29ydGVkLmZpbmRJbmRleChtb2QgPT4gbW9kLmlkID09PSBrZXkpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXNzaWduZWRJZHggPSBtaW5pbXVtSWR4ICsgaWR4O1xyXG4gICAgICAgICAgICAgICAgYWNjdW1ba2V5XSA9IHtcclxuICAgICAgICAgICAgICAgICAgLi4ubG9FbnRyeSxcclxuICAgICAgICAgICAgICAgICAgcG9zOiBhc3NpZ25lZElkeCxcclxuICAgICAgICAgICAgICAgICAgcHJlZml4OiBhc3NpZ25lZElkeCArIDEsXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgICAgICAgICAgIH0sIG1hbnVhbExPKTtcclxuXHJcbiAgICAgICAgICAgICAgY29udGV4dC5hcGkuc3RvcmUuZGlzcGF0Y2goYWN0aW9ucy5zZXRMb2FkT3JkZXIocHJvZmlsZS5pZCwgbmV3TE8gYXMgYW55KSk7XHJcbiAgICAgICAgICAgICAgaWYgKHJlZnJlc2hGdW5jICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJlZnJlc2hGdW5jKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBhbGxvd1JlcG9ydCA9ICEoZXJyIGluc3RhbmNlb2YgdXRpbC5DeWNsZUVycm9yKTtcclxuICAgICAgICAgICAgICBjb250ZXh0LmFwaS5zaG93RXJyb3JOb3RpZmljYXRpb24oJ0ZhaWxlZCB0byBzb3J0IGJ5IGRlcGxveW1lbnQgb3JkZXInLCBlcnIsXHJcbiAgICAgICAgICAgICAgICB7IGFsbG93UmVwb3J0IH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9fSxcclxuICAgICAgXSk7XHJcbiAgICB9LCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHN0YXRlID0gY29udGV4dC5hcGkuc3RvcmUuZ2V0U3RhdGUoKTtcclxuICAgICAgY29uc3QgZ2FtZU1vZGUgPSBzZWxlY3RvcnMuYWN0aXZlR2FtZUlkKHN0YXRlKTtcclxuICAgICAgcmV0dXJuIGdhbWVNb2RlID09PSBHQU1FX0lEO1xyXG4gICAgfSk7XHJcbn07XHJcbiJdfQ==