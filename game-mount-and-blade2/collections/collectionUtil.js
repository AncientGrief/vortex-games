"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.genCollectionLoadOrder = exports.isModInCollection = exports.isValidMod = exports.CollectionParseError = exports.CollectionGenerateError = void 0;
const vortex_api_1 = require("vortex-api");
const common_1 = require("../common");
class CollectionGenerateError extends Error {
    constructor(why) {
        super(`Failed to generate game specific data for collection: ${why}`);
        this.name = 'CollectionGenerateError';
    }
}
exports.CollectionGenerateError = CollectionGenerateError;
class CollectionParseError extends Error {
    constructor(collectionName, why) {
        super(`Failed to parse game specific data for collection ${collectionName}: ${why}`);
        this.name = 'CollectionGenerateError';
    }
}
exports.CollectionParseError = CollectionParseError;
function isValidMod(mod) {
    return ((mod === null || mod === void 0 ? void 0 : mod.type) !== 'collection');
}
exports.isValidMod = isValidMod;
function isModInCollection(collectionMod, mod) {
    if (collectionMod.rules === undefined) {
        return false;
    }
    return collectionMod.rules.find(rule => vortex_api_1.util.testModReference(mod, rule.reference)) !== undefined;
}
exports.isModInCollection = isModInCollection;
function genCollectionLoadOrder(loadOrder, mods, collection) {
    const filteredMods = (collection !== undefined)
        ? Object.keys(mods)
            .filter(id => isValidMod(mods[id]) && isModInCollection(collection, mods[id]))
            .reduce((accum, iter) => {
            accum[iter] = mods[iter];
            return accum;
        }, {})
        : mods;
    const sortedMods = Object.keys(loadOrder)
        .filter(id => isValidSubMod(id, filteredMods))
        .sort((lhs, rhs) => loadOrder[lhs].pos - loadOrder[rhs].pos)
        .reduce((accum, iter, idx) => {
        accum[iter] = Object.assign(Object.assign({}, loadOrder[iter]), { pos: idx });
        return accum;
    }, {});
    return sortedMods;
}
exports.genCollectionLoadOrder = genCollectionLoadOrder;
function isValidSubMod(subModId, mods) {
    if (common_1.OFFICIAL_MODULES.has(subModId)) {
        return true;
    }
    const modIds = Object.keys(mods);
    const subModIds = modIds.reduce((accum, id) => { var _a, _b; return accum.concat([id], ((_b = (_a = mods[id]) === null || _a === void 0 ? void 0 : _a['attributes']) === null || _b === void 0 ? void 0 : _b['subModIds']) || []); }, []);
    return subModIds.map(id => id.toLowerCase()).includes(subModId.toLowerCase());
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvblV0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb2xsZWN0aW9uVXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FBeUM7QUFHekMsc0NBQTZDO0FBRTdDLE1BQWEsdUJBQXdCLFNBQVEsS0FBSztJQUNoRCxZQUFZLEdBQVc7UUFDckIsS0FBSyxDQUFDLHlEQUF5RCxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxJQUFJLEdBQUcseUJBQXlCLENBQUM7SUFDeEMsQ0FBQztDQUNGO0FBTEQsMERBS0M7QUFFRCxNQUFhLG9CQUFxQixTQUFRLEtBQUs7SUFDN0MsWUFBWSxjQUFzQixFQUFFLEdBQVc7UUFDN0MsS0FBSyxDQUFDLHFEQUFxRCxjQUFjLEtBQUssR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNyRixJQUFJLENBQUMsSUFBSSxHQUFHLHlCQUF5QixDQUFDO0lBQ3hDLENBQUM7Q0FDRjtBQUxELG9EQUtDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLEdBQWU7SUFDeEMsT0FBTyxDQUFDLENBQUEsR0FBRyxhQUFILEdBQUcsdUJBQUgsR0FBRyxDQUFFLElBQUksTUFBSyxZQUFZLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBRkQsZ0NBRUM7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxhQUF5QixFQUFFLEdBQWU7SUFDMUUsSUFBSSxhQUFhLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtRQUNyQyxPQUFPLEtBQUssQ0FBQztLQUNkO0lBRUQsT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNyQyxpQkFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUM7QUFDOUQsQ0FBQztBQVBELDhDQU9DO0FBRUQsU0FBZ0Isc0JBQXNCLENBQUMsU0FBK0MsRUFDL0MsSUFBcUMsRUFDckMsVUFBdUI7SUFDNUQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzthQUNkLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxpQkFBaUIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDN0UsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3RCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ1YsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUVULE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1NBQ3RDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDN0MsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO1NBQzNELE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxtQ0FDTixTQUFTLENBQUMsSUFBSSxDQUFDLEtBQ2xCLEdBQUcsRUFBRSxHQUFHLEdBQ1QsQ0FBQztRQUNGLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQztBQXZCRCx3REF1QkM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxRQUFnQixFQUFFLElBQXFDO0lBQzVFLElBQUkseUJBQWdCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBRWxDLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFJRCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLE1BQU0sU0FBUyxHQUFhLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsZUFDdEQsT0FBQSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQSxNQUFBLE1BQUEsSUFBSSxDQUFDLEVBQUUsQ0FBQywwQ0FBRyxZQUFZLENBQUMsMENBQUcsV0FBVyxDQUFDLEtBQUksRUFBRSxDQUFDLENBQUEsRUFBQSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRXpFLE9BQU8sU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUNoRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdHlwZXMsIHV0aWwgfSBmcm9tICd2b3J0ZXgtYXBpJztcclxuaW1wb3J0IHsgSUxvYWRPcmRlciwgSUxvYWRPcmRlckVudHJ5IH0gZnJvbSAnLi4vdHlwZXMnO1xyXG5cclxuaW1wb3J0IHsgT0ZGSUNJQUxfTU9EVUxFUyB9IGZyb20gJy4uL2NvbW1vbic7XHJcblxyXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvbkdlbmVyYXRlRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgY29uc3RydWN0b3Iod2h5OiBzdHJpbmcpIHtcclxuICAgIHN1cGVyKGBGYWlsZWQgdG8gZ2VuZXJhdGUgZ2FtZSBzcGVjaWZpYyBkYXRhIGZvciBjb2xsZWN0aW9uOiAke3doeX1gKTtcclxuICAgIHRoaXMubmFtZSA9ICdDb2xsZWN0aW9uR2VuZXJhdGVFcnJvcic7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvblBhcnNlRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgY29uc3RydWN0b3IoY29sbGVjdGlvbk5hbWU6IHN0cmluZywgd2h5OiBzdHJpbmcpIHtcclxuICAgIHN1cGVyKGBGYWlsZWQgdG8gcGFyc2UgZ2FtZSBzcGVjaWZpYyBkYXRhIGZvciBjb2xsZWN0aW9uICR7Y29sbGVjdGlvbk5hbWV9OiAke3doeX1gKTtcclxuICAgIHRoaXMubmFtZSA9ICdDb2xsZWN0aW9uR2VuZXJhdGVFcnJvcic7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZE1vZChtb2Q6IHR5cGVzLklNb2QpIHtcclxuICByZXR1cm4gKG1vZD8udHlwZSAhPT0gJ2NvbGxlY3Rpb24nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTW9kSW5Db2xsZWN0aW9uKGNvbGxlY3Rpb25Nb2Q6IHR5cGVzLklNb2QsIG1vZDogdHlwZXMuSU1vZCkge1xyXG4gIGlmIChjb2xsZWN0aW9uTW9kLnJ1bGVzID09PSB1bmRlZmluZWQpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHJldHVybiBjb2xsZWN0aW9uTW9kLnJ1bGVzLmZpbmQocnVsZSA9PlxyXG4gICAgdXRpbC50ZXN0TW9kUmVmZXJlbmNlKG1vZCwgcnVsZS5yZWZlcmVuY2UpKSAhPT0gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2VuQ29sbGVjdGlvbkxvYWRPcmRlcihsb2FkT3JkZXI6IHsgW21vZElkOiBzdHJpbmddOiBJTG9hZE9yZGVyRW50cnkgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kczogeyBbbW9kSWQ6IHN0cmluZ106IHR5cGVzLklNb2QgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbj86IHR5cGVzLklNb2QpOiBJTG9hZE9yZGVyIHtcclxuICBjb25zdCBmaWx0ZXJlZE1vZHMgPSAoY29sbGVjdGlvbiAhPT0gdW5kZWZpbmVkKVxyXG4gICAgPyBPYmplY3Qua2V5cyhtb2RzKVxyXG4gICAgICAgIC5maWx0ZXIoaWQgPT4gaXNWYWxpZE1vZChtb2RzW2lkXSkgJiYgaXNNb2RJbkNvbGxlY3Rpb24oY29sbGVjdGlvbiwgbW9kc1tpZF0pKVxyXG4gICAgICAgIC5yZWR1Y2UoKGFjY3VtLCBpdGVyKSA9PiB7XHJcbiAgICAgICAgICBhY2N1bVtpdGVyXSA9IG1vZHNbaXRlcl07XHJcbiAgICAgICAgICByZXR1cm4gYWNjdW07XHJcbiAgICAgICAgfSwge30pXHJcbiAgICA6IG1vZHM7XHJcblxyXG4gIGNvbnN0IHNvcnRlZE1vZHMgPSBPYmplY3Qua2V5cyhsb2FkT3JkZXIpXHJcbiAgICAuZmlsdGVyKGlkID0+IGlzVmFsaWRTdWJNb2QoaWQsIGZpbHRlcmVkTW9kcykpXHJcbiAgICAuc29ydCgobGhzLCByaHMpID0+IGxvYWRPcmRlcltsaHNdLnBvcyAtIGxvYWRPcmRlcltyaHNdLnBvcylcclxuICAgIC5yZWR1Y2UoKGFjY3VtLCBpdGVyLCBpZHgpID0+IHtcclxuICAgICAgYWNjdW1baXRlcl0gPSB7XHJcbiAgICAgICAgLi4ubG9hZE9yZGVyW2l0ZXJdLFxyXG4gICAgICAgIHBvczogaWR4LFxyXG4gICAgICB9O1xyXG4gICAgICByZXR1cm4gYWNjdW07XHJcbiAgICB9LCB7fSk7XHJcbiAgcmV0dXJuIHNvcnRlZE1vZHM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzVmFsaWRTdWJNb2Qoc3ViTW9kSWQ6IHN0cmluZywgbW9kczogeyBbbW9kSWQ6IHN0cmluZ106IHR5cGVzLklNb2QgfSkge1xyXG4gIGlmIChPRkZJQ0lBTF9NT0RVTEVTLmhhcyhzdWJNb2RJZCkpIHtcclxuICAgIC8vIG9mZmljaWFsIG1vZHVsZXMgYXJlIGFsd2F5cyBpbmNsdWRlZC5cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLy8gVGhlIG1vZHMgbWFwIHNob3VsZCBvbmx5IGluY2x1ZGUgbW9kcyB0aGF0IGhhdmUgYmVlbiBpbmNsdWRlZCBpbiB0aGVcclxuICAvLyAgY29sbGVjdGlvbiBvciB0aGlzIHdvbid0IHdvcmsuXHJcbiAgY29uc3QgbW9kSWRzID0gT2JqZWN0LmtleXMobW9kcyk7XHJcbiAgY29uc3Qgc3ViTW9kSWRzOiBzdHJpbmdbXSA9IG1vZElkcy5yZWR1Y2UoKGFjY3VtLCBpZCkgPT5cclxuICAgIGFjY3VtLmNvbmNhdChbaWRdLCBtb2RzW2lkXT8uWydhdHRyaWJ1dGVzJ10/Llsnc3ViTW9kSWRzJ10gfHwgW10pLCBbXSk7XHJcblxyXG4gIHJldHVybiBzdWJNb2RJZHMubWFwKGlkID0+IGlkLnRvTG93ZXJDYXNlKCkpLmluY2x1ZGVzKHN1Yk1vZElkLnRvTG93ZXJDYXNlKCkpO1xyXG59XHJcbiJdfQ==